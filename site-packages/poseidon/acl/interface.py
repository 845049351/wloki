#!/usr/bin/env python

from datetime import datetime
from .database import DomainList
from loki.db import db_cdn_system as db


class ACLInterface(object):

    def get_acl_table(self):
        q = DomainList.query.all()
        table = [
            {
                'domain': row.domain,
                'user_list': sorted(row.users.split(','))
            }
            for row in q
        ]
        return table

    def get_user_list(self, domain):
        acl_table = self.get_acl_table()
        user_list = (d for d in acl_table if d['domain'] == domain).next()['user_list']
        return user_list

    def update_user_list(self, domain, user_list):
        assert isinstance(user_list, list)
        users = ','.join(user_list)
        now = datetime.now()
        row = DomainList.query.get(domain)
        row.users = users
        row.update_time = now
        row.save(bind=db)

    def add_user(self, domain, user):
        user_list = self.get_user_list(domain)
        if user not in user_list:
            user_list.append(user)
            self.update_user_list(domain, user_list)
        return None

    def del_user(self, domain, user):
        user_list = self.get_user_list(domain)
        try:
            user_list.remove(user)
        except ValueError:
            return None
        self.update_user_list(domain, user_list)
